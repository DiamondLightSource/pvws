<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Custom PV Web Socket Example</title>
<link rel="stylesheet" type="text/css" href="css/pvws.css">

<!-- This example uses the pvws.js library as an example,
  -- but in principle you can connect to the web socket
  -- and handle the data any way you prefer.
  -- The pvws.js code depend on jquery and base64.js.
  -->
<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="js/pvws.js"></script>
</head>
<body>

<h1>Custom PV Web Socket Example</h1>
<p>
This demonstration connects to fixed PV names and shows their current value.
In your own implementation, you may decide to not show the PV names,
or allow end-users to enter names directly on your page.
</p>

<div id="info">
  <table style="width: 50%">
    <thead>
      <tr><th>PV Name</th><th>Value</th></tr>
    </thead>
    <tbody id="pvs">
      <tr><td>sim://sine</td>  <td></td></tr>
      <tr><td>sim://noise</td> <td></td></tr>
      <tr><td>loc://x(42)</td> <td></td></tr>
    </tbody>
  </table>
</div>


<script type="text/javascript">

// Our web page contains a table with PV names, fetch them.
// Later, the PV Web Socket will send us values by PV name,
// so locate table cells where we can display the result.

let pv_cells = new Map();
jQuery("#pvs tr").each( (index, tr) =>
{
	// Get PV name and the 'next' cell for displaying result from table row
	let pvname = jQuery(tr).find("td").first().text();
    let cell = jQuery(tr).find("td").last();
    // Remember cell by PV name
    pv_cells.set(pvname, cell);
});


// Update URLs based on the actual location of this page.
// Your web page might hardcode the wsurl.
let wsurl = window.location.pathname
wsurl = wsurl.substring(0, wsurl.indexOf("/pvws"))
wsurl = window.location.host + wsurl + "/pvws/pv"
if (window.location.protocol == "https:")
    wsurl = "wss://" + wsurl
else
    wsurl = "ws://" + wsurl


// Create PV Web Socket,
// register handler for connection changes
// and value updates
let pvws = new PVWS(wsurl,
    connected =>
    {
    	if (connected)
   		{   // On connection, subscribe to all PVs
     		for (let pv of pv_cells.keys())
    		    pvws.subscribe(pv);
   		}
    	else
   		{   // Indicate disconnect
            for (let cell of pv_cells.values())
            	cell.text("- not connected -");
   		}
    },
    message =>
    {
    	// Value update can contain actual value plus formatting hints
    	// like precision and units
        // console.log(JSON.stringify(message, null, 2));
        
    	// This example formats numbers based on available hints
        let formatted;
        if (message.value === undefined)
        	formatted = "- null -";
        if (message.precision === undefined)
        	formatted = message.value;
        else
        	formatted = message.value.toFixed(message.precision);
        if (message.units)
        	formatted += " " + message.units;
        
        // Display in cell associated with this PV
        pv_cells.get(message.pv).text(formatted);
    });


//Once the page loads, open the WS
jQuery(() =>  pvws.open());

</script>

</body>
</html>