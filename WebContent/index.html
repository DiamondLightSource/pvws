<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PV Web Socket</title>
<link rel="stylesheet" type="text/css" href="css/pvws.css">
<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="js/pvws.js"></script>
</head>
<body>

<blockquote>

<h1>PV Web Socket</h1>
<p>
Web socket: <span id="url">ws://...</span> <img id="status" alt="Status" src="img/disconnected.png">
<input type="button" value="Disconnect">
</p>


<h3>Ping</h3>
<p>
A 'ping' message requests the server to 'ping' this client,
and a proper web client is supposed to automatically return a 'pong'
to the server.
(Internal test mechanism)
</p>
<pre>
{ "type": "ping" }
</pre>
<input type="button" value="Ping">


<h3>Echo</h3>
<p>
An 'echo' JSON message is simply returned.
</p>
<pre>
{ "type": "echo", "body": "Hello, echo", "other": "Whatever else" }
</pre>
<form>
  <input type="text" id="text" size="40" value="Hello, echo!">
  <input type="button" value="Echo">
</form>


<h3>Subscribe to PVs</h3>
<p>
A 'subscribe' JSON message requests updates for one or more PVs.
</p>
<pre>
{ "type": "subscribe", "pvs": [ "sim://sine", "loc://x(4)" ] }
</pre>

<p>
A 'clear' JSON message cancels updates for one or more PVs.
</p>
<pre>
{ "type": "clear", "pvs": [ "sim://sine", "loc://x(4)" ] }
</pre>
<form>
  <input type="text" id="pv_name" size="40" value="sim://sine">
  <br>
  <input type="button" value="Subscribe">
  <input type="button" value="UnSubscribe">
</form>

<p>
Value updates are JSON messages with the following elements:
</p>

<dl>
  <dt>type</dt>       <dd>'update'</dd>
  <dt>pv</dt>         <dd>PV Name</dd>
  <dt>severity</dt>   <dd>NONE, MINOR, MAJOR, INVALID, UNDEFINED</dd>
  <dt>value</dt>      <dd>Value of numeric PV or 'NaN'; Enum PV's numeric value</dd>
  <dt>text</dt>       <dd>Value of text PV; Selected label of enum PV</dd>
  <dt>units</dt>      <dd>Numeric PV units</dd>
  <dt>precision</dt>  <dd>Numeric PV precision</dd>
  <dt>labels</dt>     <dd>Array of labels for enum PV</dd>
</dl>

<p>
The web socket sends the complete meta data (units, labels, ..) on the first update.
Further messages only contain the changed severity and value/text.
The client library merges received data and thus always presents the complete PV information.
</p>

<p>
For arrays, the web socket sends the data in a field 'b64dbl' or 'b64int' which contains
the Base-64 encoded binary array of double respectively int values, using little-endian byte order.
The client library decodes the binary data into the value field, presenting a double resp. int array.
</p>

<h3>List</h3>
<p>
A 'list' JSON message requests a list of PVs.
</p>
<pre>
{ "type": "list" }
</pre>
<input type="button" value="List">

<h3>Messages</h3>

<textarea id="messages" rows="10" style="width: 100%"></textarea>
<input type="button" value="Clear">


</blockquote>

<script type="text/javascript">
let wsurl = window.location.pathname
wsurl = wsurl.substring(0, wsurl.indexOf("/pvws"))
wsurl = window.location.host + wsurl + "/pvws/pv"
if (window.location.protocol == "https:")
    wsurl = "wss://" + wsurl
else
    wsurl = "ws://" + wsurl

jQuery("#url").html(wsurl);
    
let pvws = new PVWS(wsurl,
    connected =>
	{
	    if (connected)
	        jQuery("#url").html(pvws.url);
	    else
	        jQuery("#messages").val("");
	    jQuery("#status").attr("src", connected ? "img/connected.png" : "img/disconnected.png");
    },
    message =>
    {
        let resp = jQuery("#messages");
        resp.val(JSON.stringify(message, null, 2));
    });
    
    
// Prevent 'enter' from submitting a form and thus reloading the page
jQuery("form").submit(e => false);

jQuery("input[type=button][value=Disconnect]") .click(() => pvws.close() );
jQuery("input[type=button][value=Ping]")       .click(() => pvws.ping() );
jQuery("input[type=button][value=Subscribe]")  .click(() => pvws.subscribe(jQuery("#pv_name").val()) );
jQuery("input[type=button][value=UnSubscribe]").click(() => pvws.clear(jQuery("#pv_name").val()) );
jQuery("input[type=button][value=List]")       .click(() => pvws.list() );
jQuery("input[type=button][value=Echo]")       .click(() =>
       pvws.socket.send(JSON.stringify({ type: 'echo', body: jQuery("#text").val() })));
jQuery("input[type=button][value=Clear]")      .click(() => jQuery("#messages").val("") );

jQuery(() => pvws.open());
</script>

</body>
</html>
