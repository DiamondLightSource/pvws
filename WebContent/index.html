<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PV Web Socket</title>
<link rel="stylesheet" type="text/css" href="css/pvws.css">
<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
<script type="text/javascript" src="js/pvws.js"></script>
</head>
<body>

<blockquote>

<h1>PV Web Socket</h1>
<p>
Web socket: <span id="url">ws://...</span> <img id="status" alt="Status" src="img/disconnected.png">
<input type="button" value="Disconnect">
</p>


<h3>Ping</h3>
<p>
A 'ping' message requests the server to 'ping' this client,
and a proper web client is supposed to automatically return a 'pong'
to the server.
(Internal test mechanism)
</p>
<pre>
{ "type": "ping" }
</pre>
<input type="button" value="Ping">


<h3>Echo</h3>
<p>
An 'echo' JSON message is simply returned.
</p>
<pre>
{ "type": "echo", "body": "Hello, echo", "other": "Whatever else" }
</pre>
<form>
  <input type="text" id="text" size="40" value="Type...">
  <input type="button" value="Echo">
</form>


<h3>Subscribe to PVs</h3>
<p>
A 'subscribe' JSON message requests updates for one or more PVs.
</p>
<pre>
{ "type": "subscribe", "pvs": [ "sim://sine", "loc://x(4)" ] }
</pre>

<p>
A 'clear' JSON message cancels updates for one or more PVs.
</p>
<pre>
{ "type": "clear", "pvs": [ "sim://sine", "loc://x(4)" ] }
</pre>
<form>
  <input type="text" id="pv_name" size="40" value="sim://sine">
  <br>
  <input type="button" value="Subscribe">
  <input type="button" value="UnSubscribe">
</form>


<h3>List</h3>
<p>
A 'list' JSON message requests a list of PVs.
</p>
<pre>
{ "type": "list" }
</pre>
<input type="button" value="List">

<h3>Messages</h3>

<textarea id="messages" rows="20" cols="50"></textarea>
  <input type="button" value="Clear">


</blockquote>

<script type="text/javascript">
let pvws = new PVWS("ws://localhost:8080/pvws/pv",
    connected =>
	{
	    if (connected)
	        jQuery("#url").html(pvws.url);
	    else
	        jQuery("#messages").val("");
	    jQuery("#status").attr("src", connected ? "img/connected.png" : "img/disconnected.png");
    },
    message =>
    {
        let resp = jQuery("#messages");
        resp.val(resp.val() + JSON.stringify(message, null, 2));
    });

jQuery("input[type=button][value=Disconnect]") .click(() => pvws.close() );
jQuery("input[type=button][value=Ping]")       .click(() => pvws.ping() );
jQuery("input[type=button][value=Subscribe]")  .click(() => pvws.subscribe(jQuery("#pv_name").val()) );
jQuery("input[type=button][value=UnSubscribe]").click(() => pvws.clear(jQuery("#pv_name").val()) );
jQuery("input[type=button][value=List]")       .click(() => pvws.list() );
jQuery("input[type=button][value=Echo]")       .click(() =>
       pvws.socket.send(JSON.stringify({ type: 'echo', body: jQuery("#text").val() })));
jQuery("input[type=button][value=Clear]")      .click(() => jQuery("#messages").val("") );

jQuery(() => pvws.open());
</script>

</body>
</html>
